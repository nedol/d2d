SELECT  date, of.categories as cats,  of.latitude as lat, of.longitude as lon, of.radius, of.data as data,  of.deleted as deleted, sup.uid as uid, sup.dict as dict, sup.profile as profile, sup.rating as rating,  apprs.totals as apprs FROM  supplier as sup, promo, offers as of, ( SELECT COUNT(*) as  totals FROM supplier as sup, approved as appr WHERE appr.supuid=sup.uid AND appr.date='2022-10-28' ) AS apprs WHERE sup.uid = of.supuid AND LCASE(sup.promo)=LCASE(promo.code) AND of.latitude>=38.45 AND of.latitude<=38.55 AND of.longitude>=-122.85 AND of.longitude<=-122.75 AND ( (SELECT id  FROM offers WHERE supuid LIKE sup.uid AND DATE(date)<=DATE('2022-10-28') ORDER BY date DESC LIMIT 1)= of.id OR  (SELECT id  FROM offers WHERE supuid LIKE sup.uid AND DATE(date)>=DATE('2022-10-21') ORDER BY date ASC LIMIT 1)= of.id ) AND of.deleted IS NULL  ORDER by uid, date DESC