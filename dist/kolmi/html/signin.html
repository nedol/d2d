<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<!-- Bootstrap core CSS -->
<link href="../css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
<script
        src="https://code.jquery.com/jquery-2.2.4.min.js"
        integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
        crossorigin="anonymous"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="../assets/vendor/blueimp-load-image/js/load-image.js"></script>
<script src="../assets/vendor/blueimp-load-image/js/load-image-scale.js"></script>
<script>


</script>
<body onload="FillForm()">
<div id="signin_form" class="container">
    <style>
        .form-signin {
            max-width: 330px;
            padding: 15px;
            margin: 0 auto;
        }
        .form-signin .form-signin-heading,
        .form-signin .checkbox {
            margin-bottom: 10px;
        }
        .form-signin .checkbox {
            font-weight: normal;
        }
        .form-signin .form-control {
            position: relative;
            height: auto;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            padding: 10px;
            font-size: 16px;
        }
        .form-signin .form-control:focus {
            z-index: 2;
        }
        .form-signin input[type="email"] {
            margin-bottom: -1px;
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 0;
        }
        .form-signin input[type="password"] {
            margin-bottom: 10px;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
    </style>

<script>
    function getBase64Image(img) {
        // Create an empty canvas element
        var canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;

        // Copy the image contents to the canvas
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);

        // Get the data-URL formatted image
        // Firefox supports PNG and JPEG. You could check img.src to
        // guess the original format, but be aware the using "image/jpg"
        // will re-encode the image.
        var dataURL = canvas.toDataURL("image/png");

        return dataURL;//.replace(/^data:image\/(png|jpg);base64,/, "");
    }

    function OnClick() {
        $(".file-upload").on('change', function(e){
            try {

                loadImage(
                    e.target.files[0],
                    function (img, data) {
                        if (img.type === "error") {
                            console.error("Error loading image ");
                        } else {

                            var scaledImage = loadImage.scale(
                                img, // img or canvas element
                                { maxWidth: 300}
                            );
                            let this_img = getBase64Image(scaledImage);

                            $('.avatar').attr('src', this_img);

                            $('.avatar').siblings('input:file').attr('changed',true);
                            console.log("Original image width: ", img.originalWidth);
                            console.log("Original image height: ", img.originalHeight);

                        }
                    },
                    {
                        orientation: true,
                        maxWidth: 300,
                        canvas: true
                    }
                );
            }catch(ex){
                console.log(ex);
            }

        });

    }

    function FillForm(){
        let items = JSON.parse(localStorage.getItem('kolmi_abonent'));
        if(items)
            $('input').each(function (index, el) {
                if(items[el.id]){
                    if($('#'+el.id).attr('type')==='file'){
                        $('img.'+el.id).attr('src',items[el.id]);
                    }else{
                        $('#'+el.id).val(items[el.id]);
                    }

                    return;
                }

            });

        try {
            window.parent.document.addEventListener("scroll", inView);
        }catch(ex){

        }
    }

    function GetProfileItems(){
        let profile = {};
        $('input').each(function (index, inp) {
            if($(this).attr('type')==='file'){
                profile['avatar'] = $(this).siblings('img').attr('src');
                return;
            }
            profile[inp.id] = $(inp).val();
        });
        return profile;
    }

    function SaveProfile(){
        let uid  = getParameterByName('uid');
        let items = GetProfileItems();
        localStorage.setItem('kolmi_abonent',JSON.stringify(items));

        let profile = {};
        $('input').each(function (index, inp) {
            if($(this).attr('type')==='file'){
                profile['avatar'] = $(this).siblings('img').attr('src');
                return;
            }
            profile[inp.id] = $(inp).val();
        });

        parent.postMessage(JSON.stringify({remove:"user_profile"}), "*");

    }

    function inView() {
        for (let f in window.parent.$("iframe.kolmi").toArray())
            if (window.parent.$("iframe.kolmi")[f].getBoundingClientRect().bottom <= window.parent.innerHeight
                && window.parent.$("iframe.kolmi")[f].getBoundingClientRect().bottom > 0
            ) {
                if ($(".callObject").css('display') === 'block')
                    window.parent.$('#kolmi_profile').css('display', 'block');
                break;
            } else {
                window.parent.$('#kolmi_profile').css('display', 'none');
            }
    }

    function getParameterByName (name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
</script>
    <div class="row" style="border-style: groove; border-radius:2px;border-color: #cbced2;padding: 10px">
        <h2 class="form-signin-heading">Как Вас представить?</h2>
        <div class="col-xs-6 col-sm-3 col-md-3">
            <img src="http://delivery-angels.ru/d2d/dist/images/user.png" class="img-circle img-thumbnail avatar"
            width="200px" alt="avatar"
                onclick="$(this).siblings('.file-upload').trigger('click');OnClick();">
            <h6>Upload your photo...</h6>
            <input type="file" id="avatar" class="center-block file-upload" style="display: none">

        </div>
        <div class="col-xs-6 col-sm-9 col-md-9">
            <label for="name">Имя:</label>
            <input type="text" id="name" class="form-control" placeholder="Last Name" required>
            <label for="email">Email:</label>
            <input type="email" id="email" class="form-control" placeholder="Email address" required>
            <div for="send_form">&nbsp;</div>
            <button id="send_form" class="btn btn-primary" onclick="SaveProfile()">Сохранить и закрыть</button>
        </div>

    </div>

</div> <!-- /container -->
</body>
</html>